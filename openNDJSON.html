<!DOCTYPE html>
<html>
<head>
    <title>NDJSON Processor</title>
    <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/json-viewer@3.0.1/dist/json-viewer.min.css">
    <script src="https://cdn.jsdelivr.net/npm/json-viewer@3.0.1/dist/json-viewer.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            line-height: 1.6;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        h1, h2, h3 {
            color: #333;
        }
        .data-section {
            margin-bottom: 30px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background-color: #fafafa;
        }
        .taxonomy-category {
            margin-bottom: 25px;
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        .taxonomy-category h3 {
            margin-top: 0;
            color: #2c3e50;
            padding-bottom: 8px;
            border-bottom: 1px solid #e0e0e0;
            text-transform: capitalize;
        }
        
        .taxonomy-items {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 10px;
        }
        
        .taxonomy-item {
            margin: 5px 0;
            padding: 8px 12px;
            background: #f8f9fa;
            border-left: 4px solid #4CAF50;
            border-radius: 4px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
            flex: 1 1 calc(33.333% - 20px);
            min-width: 200px;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        
        .taxonomy-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }
        .taxonomy-key {
            font-weight: bold;
            color: #2c3e50;
            text-transform: capitalize;
        }
        .taxonomy-color {
            display: inline-block;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            margin-right: 10px;
            vertical-align: middle;
        }
        .stats-container, .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        
        .stat-card {
            background: white;
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            text-align: center;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        .stat-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        
        .stat-card::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            width: 0;
            height: 3px;
            background: linear-gradient(90deg, #3498db, #2ecc71);
            transition: width 0.3s ease;
        }
        
        .stat-card:hover::after {
            width: 100%;
        }
        
        .stat-value {
            font-size: 24px;
            font-weight: 700;
            margin: 10px 0;
            color: #3498db;
        }
        
        .stat-label {
            font-size: 14px;
            color: #7f8c8d;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .chart-card {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            padding: 15px;
            transition: transform 0.3s ease;
            min-height: 350px;
            display: flex;
            flex-direction: column;
        }
        
        .chart-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.15);
        }
        
        .chart-title {
            font-size: 15px;
            font-weight: 600;
            color: #2c3e50;
            margin: 0 0 15px 0;
            text-align: center;
            text-transform: uppercase;
        }
        
        .chart-container {
            flex: 1;
            min-height: 300px;
            width: 100%;
            position: relative;
            overflow: hidden;
        }
        
        .chart-container > div {
            position: absolute !important;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
        }
        
        #taxonomies-container {
            margin-top: 20px;
        }
        
        pre {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 4px;
            overflow-x: auto;
            max-height: 400px;
            overflow-y: auto;
        }
        .tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 1px solid #ddd;
        }
        .tab {
            padding: 10px 20px;
            cursor: pointer;
            border: 1px solid transparent;
            border-bottom: none;
            margin-right: 5px;
            border-radius: 4px 4px 0 0;
            font-size: 15px;
            font-weight: 600;
            color: #2c3e50;
            text-align: center;
            text-transform: uppercase;
        }
        .tab.active {
            background: #fff;
            border-color: #ddd;
            border-bottom-color: #fff;
            margin-bottom: -1px;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        .taxonomy-content {
            flex: 1;
            display: flex;
            align-items: center;
            flex-wrap: wrap;
            gap: 5px;
        }
        
        .taxonomy-count {
            background: #e0e0e0;
            color: #333;
            font-size: 0.85em;
            padding: 2px 8px;
            border-radius: 12px;
            margin-left: auto;
            white-space: nowrap;
        }
        
        @keyframes fadeOut {
            to { opacity: 0; }
        }
        
        .fullscreen {
            position: fixed !important;
            top: 0 !important;
            left: 0 !important;
            right: 0 !important;
            bottom: 0 !important;
            max-height: none !important;
            height: 100vh !important;
            z-index: 1000 !important;
            border-radius: 0 !important;
            border: none !important;
            padding: 50px 20px 20px !important;
            background: white !important;
        }
        
        .fullscreen #json-viewer {
            height: calc(100vh - 100px) !important;
        }
        
        .header-container {
            width: 100%;
            margin-bottom: 20px;
        }
        
        .document-meta {
            font-size: 0.9em;
            color: #666;
            margin-top: 10px;
            display: flex;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 15px;
        }
        
        .document-meta > div {
            display: flex;
            align-items: center;
            gap: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header-container">
            <h1 id="document-title">NDJSON Data Processor</h1>
            <div id="document-meta" class="document-meta">
                <div id="document-timestamp"></div>
                <div id="document-model"></div>
            </div>
        </div>
        <div id="loading">Loading data...</div>
        <div id="content" style="display: none;">
            <h3 style="color: #2c3e50; text-transform: uppercase; text-align: center; font-size: 15px; font-weight: 600;">Document Statistics and Analytics</h3>
            <div class="stats-container" id="document-stats">
                <div class="stat-card">
                    <div class="stat-value" id="total-tokens">-</div>
                    <div class="stat-label">Total Tokens</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="prompt-tokens">-</div>
                    <div class="stat-label">Prompt Tokens</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="completion-tokens">-</div>
                    <div class="stat-label">Completion Tokens</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="total-items">-</div>
                    <div class="stat-label">Total Lines</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="total-taxonomies">-</div>
                    <div class="stat-label">Total Taxonomies</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="total-terms">-</div>
                    <div class="stat-label">Total Terms</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="document-words">-</div>
                    <div class="stat-label">Words</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="document-sentences">-</div>
                    <div class="stat-label">Sentences</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="model-name">-</div>
                    <div class="stat-label">Model</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="confidence">-</div>
                    <div class="stat-label">Confidence</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="prompt">-</div>
                    <div class="stat-label">Prompt %</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="completion">-</div>
                    <div class="stat-label">Completion %</div>
                </div>
            </div>

            <div class="stats-container">
                <div class="chart-card">
                    <div id="token-distribution-chart" class="chart-container"></div>
                </div>
                <div class="chart-card">
                    <div id="avg-tokens-chart" class="chart-container"></div>
                </div>
            </div>

            <div class="chart-card">
                <div id="taxonomy-treemap" class="chart-container"></div>
            </div>
            
            <div class="tabs" style="margin-top: 30px;">
                <div class="tab active" data-tab="taxonomies">Taxonomies</div>
                <div class="tab" data-tab="raw-data">Raw Data</div>
            </div>

            <div class="tab-content active" id="taxonomies-content">
                <div id="taxonomies-container" class="taxonomy-categories">
                    <!-- Taxonomies will be populated here by JavaScript -->
                </div>
            </div>

            <div class="tab-content" id="raw-data-content" style="position: relative; padding: 50px 20px 20px;">
                <button class="fullscreen-btn" title="Toggle fullscreen" style="position: absolute; top: 10px; right: 80px; background: #f0f0f0; border: 1px solid #ddd; border-radius: 4px; padding: 5px 10px; cursor: pointer; z-index: 100;">⛶ Fullscreen</button>
                <button class="copy-json-btn" title="Copy JSON" style="position: absolute; top: 10px; right: 10px; background: #f0f0f0; border: 1px solid #ddd; border-radius: 4px; padding: 5px 10px; cursor: pointer; z-index: 100;">📋 Copy</button>
                <div id="json-viewer" style="background: #f8f9fa; padding: 15px; border-radius: 4px; overflow-x: auto; min-height: 300px;"></div>
                <div class="copy-success" style="position: fixed; top: 20px; left: 50%; transform: translateX(-50%); background: #4CAF50; color: white; padding: 10px 20px; border-radius: 4px; z-index: 1002; display: none; animation: fadeOut 2s ease-in-out 1s forwards;">
                    JSON copied to clipboard!
                </div>
            </div>
        </div>
    </div>

    <!-- Include the external JavaScript file -->
    <script src="js/openNDJSON.js"></script>
    
    <!-- Main application script -->
    <script>
// Global color cache for taxonomy items
window.taxonomyColors = {};

// Use the color palette from NDJSONHandler
const COLOR_PALETTE = [
    '#FF6B6B', '#4ECDC4', '#45B7D1', '#FFBE0B', '#FB5607', '#8338EC', '#3A86FF', 
    '#38B000', '#9EF01A', '#FF006E', '#D00000', '#00A896', '#028090', '#F48C06', 
    '#6A4C93', '#606C38', '#283618', '#8E44AD', '#3498DB', '#E74C3C', '#2ECC71', 
    '#F1C40F', '#E67E22', '#1ABC9C', '#9B59B6', '#34495E', '#16A085', '#C0392B', 
    '#27AE60', '#2980B9', '#8A2BE2', '#5F9EA0', '#D2691E', '#6495ED', '#DC143C'
];

// Helper function to generate a consistent color for a given string
function getRandomColor(str) {
    if (window.taxonomyColors[str]) return window.taxonomyColors[str];

    let index = str ? 
        Math.abs([...str].reduce((hash, char) => ((hash << 5) - hash) + char.charCodeAt(0), 0)) % COLOR_PALETTE.length :
        Math.floor(Math.random() * COLOR_PALETTE.length);

    return window.taxonomyColors[str] = COLOR_PALETTE[index];
}

// Helper function to format labels (snake_case to Title Case)
function formatLabel(str) {
    return str ? 
        str.replace(/^_+|_+$/g, '')
           .replace(/_+/g, ' ')
           .replace(/\b\w/g, l => l.toUpperCase())
           .trim() : 
        '';
}

// Display error message to the user
function showError(message, details = '') {
    console.error('Error:', message, details);
    document.getElementById('loading').innerHTML = `
        <div style="color: #d32f2f; padding: 20px; background: #ffebee; border-radius: 4px; margin: 20px 0;">
            <h3>Error Loading Data</h3>
            <p>${message}</p>
            ${details ? `<pre style="background: #f5f5f5; padding: 10px; border-radius: 4px; overflow-x: auto;">${details}</pre>` : ''}
            <p>Please check the console for more details.</p>
        </div>
    `;
}

// Initialize charts for token distribution and taxonomy visualization
function initCharts(stats, taxonomyData) {
        // Set explicit heights for chart containers
    document.querySelectorAll('.chart-container').forEach(container => {
        container.style.height = '400px';
    });

    // Token Distribution Chart (Doughnut)
    new ApexCharts(document.querySelector("#token-distribution-chart"), {
        series: [stats.tokens.prompt_tokens, stats.tokens.completion_tokens],
        chart: { 
            type: 'donut',
            height: '100%',
            animations: { enabled: false },
            fontFamily: 'Arial, sans-serif',
            toolbar: {
                show: true,
                offsetX: 0,
                offsetY: 10,
                tools: {
                    download: true,
                    selection: false,
                    zoom: false,
                    zoomin: false,
                    zoomout: false,
                    pan: false,
                    reset: false
                }
            },
            zoom: { enabled: false }
        },
        title: {
            text: 'Token Distribution',
            align: 'left',
            margin: 10,
            offsetX: 10,
            offsetY: 0,
            floating: false,
            style: {
                fontSize: '16px',
                fontWeight: 'bold',
                color: '#2c3e50',
                fontFamily: 'Arial, sans-serif'
            }
        },
        labels: ['Prompt Tokens', 'Completion Tokens'],
        colors: ['#3498db', '#2ecc71'],
        legend: {
            show: true,
            position: 'bottom',
            horizontalAlign: 'center',
            fontSize: '12px',
            markers: {
                width: 12,
                height: 12,
                radius: 6,
                strokeWidth: 0,
                strokeColor: '#fff',
                offsetX: 0,
                offsetY: 0
            },
            itemMargin: {
                horizontal: 15,
                vertical: 8
            },
            onItemClick: {
                toggleDataSeries: true
            },
            formatter: function(seriesName, opts) {
                if (opts && opts.w && opts.w.globals && opts.w.globals.series && opts.w.globals.series[opts.seriesIndex] !== undefined) {
                    const value = opts.w.globals.series[opts.seriesIndex];
                    return `${seriesName}: ${value.toLocaleString()}`;
                }
                return seriesName;
            }
        },
        dataLabels: {
            enabled: true,
            formatter: function(val) {
                return Math.round(val) + '%';
            },
            dropShadow: {
                enabled: true,
                top: 1,
                left: 1,
                blur: 1,
                opacity: 0.8
            }
        },
        plotOptions: {
            pie: {
                donut: {
                    size: '60%',
                    labels: {
                        show: true,
                        name: {
                            show: true,
                            fontSize: '14px',
                            fontWeight: 600,
                            color: '#2c3e50',
                            offsetY: -10
                        },
                        value: {
                            show: true,
                            fontSize: '20px',
                            fontWeight: 700,
                            color: '#2c3e50',
                            offsetY: 0,
                            formatter: function (val) {
                                return Number(val).toLocaleString();
                            }
                        },
                        total: {
                            show: true,
                            label: 'TOTAL TOKENS',
                            color: '#7f8c8d',
                            fontSize: '12px',
                            formatter: w => w.globals.seriesTotals.reduce((a, b) => a + b, 0).toLocaleString()
                        }
                    }
                }
            }
        },
        tooltip: {
            y: {
                formatter: function(value) {
                    return `${value.toLocaleString()} tokens`;
                }
            },
            style: {
                fontSize: '12px'
            }
        }
    }).render();

    // Average Tokens per Request Chart (Polar Area)
    new ApexCharts(document.querySelector("#avg-tokens-chart"), {
        series: [
            stats.tokens_average_per_request.prompt_tokens,
            stats.tokens_average_per_request.completion_tokens,
            stats.tokens_average_per_request.total_tokens
        ],
        title: {
            text: 'Average Tokens per Request',
            align: 'left',
            margin: 10,
            offsetX: 10,
            offsetY: 0,
            floating: false,
            style: {
                fontSize: '16px',
                fontWeight: 'bold',
                color: '#2c3e50',
                fontFamily: 'Arial, sans-serif'
            }
        },
        chart: { 
            type: 'polarArea',
            height: '100%',
            animations: { enabled: false },
            title: {
                text: 'Average Tokens per Request',
                align: 'left',
                margin: 10,
                offsetX: 10,
                offsetY: 10,
                floating: false,
                style: {
                    fontSize: '16px',
                    fontWeight: 'bold',
                    color: '#2c3e50',
                    fontFamily: 'Arial, sans-serif',
                    cssClass: 'apexcharts-title-text'
                }
            },
            toolbar: {
                show: true,
                offsetX: 0,
                offsetY: 10,
                tools: {
                    download: true,
                    selection: false,
                    zoom: false,
                    zoomin: false,
                    zoomout: false,
                    pan: false,
                    reset: false
                }
            },
            zoom: { enabled: false },
            fontFamily: 'Arial, sans-serif'
        },
        labels: ['Prompt Tokens', 'Completion Tokens', 'Total Tokens'],
        colors: ['#3498db', '#2ecc71', '#9b59b6'],
        stroke: { 
            colors: ['#fff'],
            width: 1.5
        },
        fill: { 
            opacity: 0.9,
            type: 'solid'
        },
        legend: {
            show: true,
            position: 'bottom',
            horizontalAlign: 'center',
            fontSize: '12px',
            markers: {
                width: 12,
                height: 12,
                radius: 6,
                strokeWidth: 0,
                strokeColor: '#fff',
                offsetX: 0,
                offsetY: 0
            },
            itemMargin: {
                horizontal: 15,
                vertical: 8
            },
            onItemClick: {
                toggleDataSeries: true
            },
            formatter: function(seriesName, opts) {
                if (opts && opts.w && opts.w.globals && opts.w.globals.series && opts.w.globals.series[opts.seriesIndex] !== undefined) {
                    const value = opts.w.globals.series[opts.seriesIndex];
                    return `${seriesName}: ${value.toLocaleString()}`;
                }
                return seriesName;
            }
        },
        dataLabels: {
            enabled: true,
            formatter: function(val, { seriesIndex, w }) {
                if (w && w.config && w.config.series && w.config.series[seriesIndex] !== undefined) {
                    return w.config.series[seriesIndex].toFixed(1) + ' tokens';
                }
                return val.toFixed(1) + ' tokens';
            },
            style: {
                fontSize: '11px',
                fontWeight: 600,
                colors: ['#2c3e50']
            },
            background: {
                enabled: true,
                opacity: 0.8,
                borderColor: '#fff',
                borderWidth: 1,
                borderRadius: 4,
                padding: 4,
                dropShadow: {
                    enabled: false
                }
            }
        },
        tooltip: {
            y: {
                formatter: function(value, { series, seriesIndex, dataPointIndex, w }) {
                    return `${value.toFixed(1)} tokens`;
                }
            },
            style: {
                fontSize: '12px'
            }
        },
        plotOptions: {
            polarArea: {
                rings: {
                    strokeWidth: 1,
                    strokeColor: '#e0e0e0'
                },
                spokes: {
                    strokeWidth: 1,
                    connectorColors: '#e0e0e0'
                }
            }
        },
        responsive: [{
            breakpoint: 768,
            options: {
                chart: {
                    width: '100%',
                    height: 400
                },
                legend: {
                    position: 'bottom',
                    horizontalAlign: 'center'
                },
                dataLabels: {
                    enabled: false
                }
            }
        }]
    }).render();

    // Taxonomy Treemap Chart
    if (taxonomyData.length > 0) {
        // Soft pastel color palette that matches the reference image
        const treemapColors = [
            '#4e79a7', // Soft blue
            '#f28e2b', // Soft orange
            '#e15759', // Soft red
            '#76b7b2', // Teal
            '#59a14f', // Green
            '#edc948', // Yellow
            '#b07aa1', // Purple
            '#ff9da7', // Pink
            '#9c755f', // Brown
            '#bab0ac'  // Gray
        ];

        // Add custom CSS for data labels
        const style = document.createElement('style');
        style.textContent = `
            .apexcharts-treemap-rect {
                filter: brightness(0.95) !important;
                transition: filter 0.2s ease !important;
            }
            .apexcharts-treemap-rect:hover {
                filter: brightness(1.1) !important;
            }
            .apexcharts-treemap-rect text {
                font-family: 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif !important;
                text-shadow: 1px 1px 2px rgba(0,0,0,0.7) !important;
                pointer-events: none !important;
            }
            .apexcharts-treemap-rect tspan.name {
                font-size: 1.1em !important;
                font-weight: 600 !important;
                fill: #ffffff !important;
                dominant-baseline: middle !important;
                text-anchor: middle !important;
                paint-order: stroke;
                stroke: rgba(0,0,0,0.5);
                stroke-width: 1.5px;
                stroke-linecap: round;
                stroke-linejoin: round;
            }
            .apexcharts-treemap-rect tspan.count {
                font-size: 1em !important;
                font-weight: 500 !important;
                fill: #f0f0f0 !important;
                opacity: 0.9 !important;
                paint-order: stroke;
                stroke: rgba(0,0,0,0.3);
                stroke-width: 1px;
                stroke-linecap: round;
                stroke-linejoin: round;
            }
        `;
        document.head.appendChild(style);

        const chartOptions = {
            chart: {
                type: 'treemap',
                height: '600px',
                toolbar: {
                    show: true,
                    tools: {
                        download: true,
                        selection: false,
                        zoom: false,
                        zoomin: false,
                        zoomout: false,
                        pan: false,
                        reset: false
                    }
                },
                fontFamily: '"Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif',
                animations: {
                    enabled: true,
                    easing: 'easeinout',
                    speed: 500
                },
                events: {
                    mounted: function(chartContext, config) {
                        // Adjust font sizes after chart is rendered
                        const textElements = document.querySelectorAll('.apexcharts-treemap-rect text');
                        textElements.forEach(text => {
                            const parent = text.parentElement;
                            if (parent) {
                                const parentWidth = parent.getBoundingClientRect().width;
                                const textLength = text.textContent.length;
                                // Calculate font size based on box width and text length
                                const calculatedSize = Math.min(16, parentWidth / Math.max(1, textLength * 0.6));
                                text.style.fontSize = `${Math.max(10, calculatedSize)}px`;
                                text.style.fontWeight = '500';
                                text.style.fontFamily = '"Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif';
                            }
                        });
                    }
                }
            },
            title: {
                text: 'Taxonomy Distribution',
                align: 'left',
                margin: 10,
                offsetX: 0,
                offsetY: 5,
                style: {
                    fontSize: '20px',
                    fontWeight: '600',
                    color: '#2c3e50',
                    fontFamily: '"Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif'
                }
            },
            series: [{
                data: taxonomyData.map((item, index) => ({
                    x: formatLabel(item.x), // Format the label
                    y: item.y,
                    fillColor: treemapColors[index % treemapColors.length]
                }))
            }],
            colors: treemapColors,
            plotOptions: {
                treemap: {
                    distributed: true,
                    enableShades: true,
                    shadeIntensity: 0.1,
                    useFillColorAsStroke: false,
                    dataLabels: {
                        enabled: true,
                        style: {
                            fontSize: '13px',
                            fontWeight: '600',
                            colors: ['#2c3e50'],
                            fontFamily: '"Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif'
                        },
                        formatter: function(text, op) {
                            if (!op || !op.rect) return '';
                            
                            const boxWidth = op.rect.width || 0;
                            const boxHeight = op.rect.height || 0;
                            const minSize = 40;
                            
                            if (boxWidth > minSize && boxHeight > minSize && op.value !== undefined) {
                                const maxChars = Math.max(3, Math.floor(boxWidth / 7));
                                const displayText = text && text.length > 0 
                                    ? text.length > maxChars 
                                        ? text.substring(0, maxChars - 3) + '...' 
                                        : text
                                    : 'Untitled';
                                
                                return [
                                    `{name|${displayText}}`,
                                    `{count|${op.value}}`
                                ].join('\n');
                            }
                            return '';
                        }
                    }
                }
            },
            dataLabels: {
                enabled: true,
                offsetY: 0,
                style: {
                    fontSize: '14px',
                    fontWeight: '700',
                    fontFamily: '"Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif',
                    colors: ['#ffffff']
                },
                dropShadow: {
                    enabled: true,
                    top: 1,
                    left: 1,
                    blur: 3,
                    color: '#000000',
                    opacity: 0.7
                },
                formatter: function(text, op) {
                    if (!op || !op.rect) return '';
                    
                    const boxWidth = op.rect.width || 0;
                    const boxHeight = op.rect.height || 0;
                    const minSize = 40; // Minimum size to show content
                    
                    if (boxWidth > minSize && boxHeight > minSize && op.value !== undefined) {
                        // Format the count with comma as thousand separator
                        const count = op.value.toLocaleString();
                        
                        // Calculate maximum characters that can fit for the name
                        const maxChars = Math.max(3, Math.floor(boxWidth / 8));
                        const displayText = (text && text.length > 0 
                            ? text.length > maxChars 
                                ? text.substring(0, maxChars - 3) + '...' 
                                : text
                            : 'Untitled');
                        
                        // Only show count if there's enough space
                        const showCount = boxWidth > 60 && boxHeight > 40;
                        
                        // Return formatted string with text and count
                        return [
                            `{name|${displayText}}`,
                            showCount ? `{count|${count}}` : ''
                        ].filter(Boolean).join('\n');
                    }
                    return '';
                }
            },
            legend: {
                show: false
            },
            tooltip: {
                enabled: true,
                style: {
                    fontSize: '13px',
                    fontFamily: '"Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif'
                },
                y: {
                    formatter: function(value) {
                        return `${value} items`;
                    }
                }
            },
            grid: {
                show: false,
                padding: {
                    top: 10,
                    right: 10,
                    bottom: 10,
                    left: 10
                }
            },
            stroke: {
                show: true,
                width: 1,
                colors: ['#ffffff']
            },
            responsive: [{
                breakpoint: 768,
                options: {
                    chart: {
                        height: '500px'
                    },
                    dataLabels: {
                        style: {
                            fontSize: '10px'
                        }
                    }
                }
            }]
        };

        const chart = new ApexCharts(document.querySelector("#taxonomy-treemap"), chartOptions);
        chart.render();
    } else {
        document.querySelector("#taxonomy-treemap").innerHTML = `
            <div style="display: flex; justify-content: center; align-items: center; height: 100%; color: #666;">
                No taxonomy data available for visualization
            </div>`;
    }
}

// Display taxonomies in the UI
function displayTaxonomies(taxonomies, container) {
    if (!taxonomies.length) {
        container.innerHTML = `
            <div style="padding: 20px; background: #fff3e0; border-radius: 4px; margin: 20px 0; border-left: 4px solid #ff9800;">
                <h3>No Taxonomies Found</h3>
                <p>No taxonomy data was found in the loaded file.</p>
            </div>`;
        return;
    }

    const groupedTaxonomies = taxonomies.reduce((acc, taxonomy) => {
        const category = formatLabel(taxonomy.key.split('.')[0]) || 'Other';
        acc[category] = acc[category] || [];
        acc[category].push(taxonomy);
        return acc;
    }, {});

    container.innerHTML = '';
    Object.entries(groupedTaxonomies).forEach(([category, items]) => {
        const categoryDiv = document.createElement('div');
        categoryDiv.className = 'taxonomy-category';
        categoryDiv.innerHTML = `<h3>${category}</h3>`;

        const itemsContainer = document.createElement('div');
        itemsContainer.className = 'taxonomy-items';

        items.forEach(taxonomy => {
            const div = document.createElement('div');
            div.className = 'taxonomy-item';
            div.style.borderLeftColor = taxonomy.color;

            const contentDiv = document.createElement('div');
            contentDiv.style.display = 'flex';
            contentDiv.style.justifyContent = 'space-between';
            contentDiv.style.alignItems = 'center';

            const leftContent = document.createElement('div');
            leftContent.style.display = 'flex';
            leftContent.style.alignItems = 'center';
            leftContent.style.gap = '8px';

            const colorSpan = document.createElement('span');
            colorSpan.className = 'taxonomy-color';
            colorSpan.style.backgroundColor = taxonomy.color;
            colorSpan.style.width = '12px';
            colorSpan.style.height = '12px';
            colorSpan.style.borderRadius = '50%';

            const keySpan = document.createElement('span');
            keySpan.className = 'taxonomy-key';
            keySpan.textContent = taxonomy.label;

            const countSpan = document.createElement('span');
            countSpan.className = 'taxonomy-count';
            countSpan.textContent = taxonomy.count;

            leftContent.append(colorSpan, keySpan);
            contentDiv.append(leftContent, countSpan);

            div.appendChild(contentDiv);
            itemsContainer.appendChild(div);
        });

        categoryDiv.appendChild(itemsContainer);
        container.appendChild(categoryDiv);
    });
}

// Initialize tabs for UI navigation
function setupTabs() {
    const tabs = document.querySelectorAll('.tab');
    tabs.forEach(tab => {
        tab.addEventListener('click', () => {
            tabs.forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));

            tab.classList.add('active');
            const content = document.getElementById(`${tab.getAttribute('data-tab')}-content`);
            if (content) {
                content.classList.add('active');
                if (tab.getAttribute('data-tab') === 'raw-data') {
                    document.getElementById('json-viewer').scrollTop = 0;
                }
            }
        });
    });

    if (!document.querySelector('.tab.active') && tabs.length) {
        tabs[0].click();
    }
}

// Initialize JSON viewer and copy functionality
function initJsonViewer(result) {
    const jsonViewer = document.getElementById('json-viewer');
    const getCircularReplacer = () => {
        const seen = new WeakSet();
        return (key, value) => {
            if (typeof value === 'object' && value !== null) {
                if (seen.has(value)) return '[Circular]';
                seen.add(value);
            }
            return value;
        };
    };

    try {
        jsonViewer.textContent = JSON.stringify(result, getCircularReplacer(), 2);
        jsonViewer.style.whiteSpace = 'pre-wrap';
        jsonViewer.style.fontFamily = 'monospace';

        const fullscreenBtn = document.querySelector('.fullscreen-btn');
        const rawDataContent = document.getElementById('raw-data-content');
        if (fullscreenBtn && rawDataContent) {
            fullscreenBtn.addEventListener('click', () => {
                rawDataContent.classList.toggle('fullscreen');
                fullscreenBtn.textContent = rawDataContent.classList.contains('fullscreen') ? 
                    '✕ Exit Fullscreen' : '⛶ Fullscreen';
            });
        }

        const copyBtn = document.querySelector('.copy-json-btn');
        const copySuccess = document.querySelector('.copy-success');
        if (copyBtn && copySuccess) {
            copyBtn.addEventListener('click', () => {
                const jsonString = JSON.stringify(result, getCircularReplacer(), 2);
                const showSuccess = () => {
                    copySuccess.style.display = 'block';
                    setTimeout(() => copySuccess.style.display = 'none', 3000);
                };

                if (navigator.clipboard?.writeText) {
                    navigator.clipboard.writeText(jsonString).then(showSuccess).catch(err => {
                        console.error('Failed to copy text:', err);
                        alert('Failed to copy JSON to clipboard');
                    });
                } else {
                    const textArea = document.createElement('textarea');
                    textArea.value = jsonString;
                    textArea.style.position = 'fixed';
                    textArea.style.opacity = '0';
                    document.body.appendChild(textArea);
                    textArea.select();
                    try {
                        if (document.execCommand('copy')) showSuccess();
                        else alert('Failed to copy JSON to clipboard');
                    } catch (err) {
                        console.error('Fallback copy failed:', err);
                        alert('Failed to copy JSON to clipboard');
                    }
                    document.body.removeChild(textArea);
                }
            });
        }
    } catch (e) {
        console.error('Error initializing JSON viewer:', e);
        jsonViewer.textContent = 'Error displaying data: ' + e.message;
        jsonViewer.style.color = 'red';
    }
}

// Main initialization
document.addEventListener('DOMContentLoaded', async () => {
    const loadingEl = document.getElementById('loading');
    loadingEl.innerHTML = 'Loading data...';

    try {
        const handler = new NDJSONHandler();
        const result = await handler.init();
        if (!result) throw new Error('Failed to load or process the NDJSON file');

        const lines = result.dataset?.lines || [];
        const taxonomies = result.dataset?.taxonomies || [];
        const stats = result.statistics || {};

        // Prepare taxonomy data for treemap
        const taxonomyData = taxonomies.map(t => ({
            x: t.label,
            y: t.count
        }));

        // Initialize UI components
        initCharts(stats, taxonomyData);
        setupTabs();
        displayTaxonomies(taxonomies, document.getElementById('taxonomies-container'));
        initJsonViewer(result);

        // Update statistics display
        document.getElementById('total-items').textContent = stats.total_lines?.toLocaleString() || 0;
        document.getElementById('total-taxonomies').textContent = stats.total_taxonomies?.toLocaleString() || 0;
        document.getElementById('total-terms').textContent = stats.total_terms?.toLocaleString() || 0;
        document.getElementById('total-tokens').textContent = stats.tokens?.total_tokens?.toLocaleString() || 0;
        document.getElementById('prompt-tokens').textContent = stats.tokens?.prompt_tokens?.toLocaleString() || 0;
        document.getElementById('completion-tokens').textContent = stats.tokens?.completion_tokens?.toLocaleString() || 0;
        document.getElementById('document-words').textContent = stats.document_words?.toLocaleString() || 0;
        document.getElementById('document-sentences').textContent = stats.document_sentences?.toLocaleString() || 0;
        document.getElementById('model-name').textContent = stats.model || 'N/A';
        document.getElementById('confidence').textContent = stats.confidence ? stats.confidence + '%' : 'N/A';
        document.getElementById('prompt').textContent = stats.token_usage_percentage?.prompt ? stats.token_usage_percentage.prompt.toFixed(2) + '%' : 'N/A';
        document.getElementById('completion').textContent = stats.token_usage_percentage?.completion ? stats.token_usage_percentage.completion.toFixed(2) + '%' : 'N/A';

        // Update document title and metadata
        if (stats.document_title) {
            document.getElementById('document-title').textContent = stats.document_title;
        }
        if (stats.document_timestamp) {
            document.getElementById('document-timestamp').textContent = stats.document_timestamp;
        }
        if (stats.model) {
            document.getElementById('document-model').textContent = `Model: ${stats.model}`;
        }

        document.getElementById('content').style.display = 'block';
        loadingEl.style.display = 'none';
        document.querySelector('.tab[data-tab="taxonomies"]')?.click();
    } catch (error) {
        showError(error.message, error.stack);
    }
});
    </script>
</body>
</html>